version: 2.1

docker_node: &docker_node
    docker:
        - image: cimg/node:13.8.0

jobs:
  build-frontend:
    <<: *docker_node
    steps:
      - checkout
      - restore_cache:
          keys: [frontend-deps]
      - run:
          name: Build front-end
          command: |
            cd frontend
            npm install
            npm run build
      - save_cache:
          paths: [frontend/node_modules]
          key: frontend-deps

  build-backend:
    <<: *docker_node
    steps:
      - checkout
      - restore_cache:
          keys: [backend-deps]
      - run:
          name: Back-end build
          command: |
             cd backend
             npm install
             npm run build
      - save_cache:
          paths: [backend/node_modules]
          key: backend-deps

  test-frontend:
    <<: *docker_node
    steps:
        - checkout
        - restore_cache:
            keys: [frontend-deps]
        - run:
            name: test frontend
            command: |
                cd frontend
                npm install
                npm run test
  test-backend:
    <<: *docker_node
    steps:
        - checkout
        - restore_cache:
            keys: [backend-deps]
        - run:
            name: test backend
            command: |
                cd backend
                npm install
                npm run test

  scan-frontend:
        <<: *docker_node
        steps:
            - checkout
            - restore_cache:
               keys: [backend-deps]
            - run: 
                name: scan frontend for vunerebility
                command: |
                    cd frontend
                    npm audit fix --force
                    npm audit --audit-level critical

  scan-backend:
        <<: *docker_node
        steps:
            - checkout
            - restore_cache:
                keys: [backend-deps]
            - run: 
                name: scan backend for vunerebility
                command: |
                    cd backend
                    npm audit fix --force
                    npm audit --audit-level critical
workflows:
  default:
    jobs:
      - build-frontend
      - build-backend
      - test-frontend:
          requires: [build-frontend]
      - test-backend:
          requires:
              - build-backend
      - scan-frontend:
          requires: [build-frontend]
      - scan-backend:
          requires:
                - build-backend

